<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡ 20å¹´æ­·å²å›æ¸¬ - é›™å‘¨ç·š MACD</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/weekOfYear.js"></script>

    <style>
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; margin: 20px; background: #f4f6f8; }
        .card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { margin-top: 0; color: #2c3e50; border-left: 5px solid #3498db; padding-left: 10px; }
        #chart { width: 100%; height: 700px; } /* åŠ é«˜åœ–è¡¨ä»¥ä¾¿è§€å¯Ÿé•·é€±æœŸ */
        .status { margin-bottom: 15px; color: #7f8c8d; font-size: 0.95em; font-family: monospace; }
        .badge { background: #3498db; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;}
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ“ˆ å°è‚¡ 2005-2025 é›™å‘¨ç·š MACD <span class="badge">Time: 2025-12-01</span></h2>
    <div class="status" id="status">ç³»çµ±ç‹€æ…‹ï¼šè³‡æ–™é‹ç®—ä¸­...</div>
    <div id="chart"></div>
</div>

<script>
    // --- 0. è¨­å®š Day.js ---
    dayjs.extend(window.dayjs_plugin_weekOfYear);

    // --- 1. [Utils] æ•¸å­¸è¨ˆç®—å·¥å…· (ä¿æŒä¸è®Š) ---
    const TechUtils = {
        calculateEMA: (data, period) => {
            const k = 2 / (period + 1);
            let emaArray = [data[0]];
            for (let i = 1; i < data.length; i++) {
                emaArray.push(data[i] * k + emaArray[i - 1] * (1 - k));
            }
            return emaArray;
        },
        calculateMACD: (closePrices, shortPeriod = 12, longPeriod = 26, midPeriod = 9) => {
            const shortEMA = TechUtils.calculateEMA(closePrices, shortPeriod);
            const longEMA = TechUtils.calculateEMA(closePrices, longPeriod);
            const dif = shortEMA.map((s, i) => s - longEMA[i]);
            const dea = TechUtils.calculateEMA(dif, midPeriod);
            const macdBar = dif.map((d, i) => (d - dea[i]) * 2);
            return { dif, dea, macdBar };
        }
    };

    // --- 2. [Service] è³‡æ–™è™•ç†å±¤ (å¤§å¹…å‡ç´šæ¨¡æ“¬é‚è¼¯) ---
    const DataService = {
        // ç”Ÿæˆ 20 å¹´è³‡æ–™ (2005 - 2025)
        generateLongTermData: () => {
            const data = [];

            // è¨­å®šèµ·å§‹èˆ‡çµæŸæ™‚é–“
            const startDate = dayjs('2005-01-01');
            const endDate = dayjs('2025-12-01'); // ç¾åœ¨æ™‚é–“

            let currentDate = startDate;

            // æ¨¡æ“¬åƒæ•¸ï¼š2005å¹´èµ·åƒ¹ 50å…ƒï¼Œæ¨¡æ“¬å°ç©é›»é•·æœŸèµ°å‹¢
            let price = 50;

            // åªè¦æ—¥æœŸé‚„æ²’è¶…é 2025-12-01 å°±ç¹¼çºŒè·‘
            while (currentDate.isBefore(endDate) || currentDate.isSame(endDate)) {
                // è·³éé€±æœ«
                const dayOfWeek = currentDate.day();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {

                    // æ¨¡æ“¬è‚¡åƒ¹éš¨æ©Ÿæ¼«æ­¥ (Random Walk with Drift)
                    // é•·æœŸè¶¨å‹¢å‘ä¸Š (Drift) + éš¨æ©Ÿæ³¢å‹• (Volatility)
                    const drift = 0.08; // æ¯æ—¥å¾®å¹…ä¸Šæ¼²å‚¾å‘
                    const volatility = (Math.random() - 0.5) * 6; // æ³¢å‹•

                    price = price + drift + volatility;
                    if (price < 10) price = 10; // é˜²æ­¢è·Œç ´ 10 å…ƒ

                    const open = price;
                    const close = price + (Math.random() - 0.5) * 4;
                    const high = Math.max(open, close) + Math.random() * 2;
                    const low = Math.min(open, close) - Math.random() * 2;

                    data.push({
                        date: currentDate.format('YYYY-MM-DD'),
                        open, high, low, close,
                        volume: Math.floor(Math.random() * 20000 + 5000)
                    });
                }
                // åŠ ä¸€å¤©
                currentDate = currentDate.add(1, 'day');
            }
            return data;
        },

        // é›™å‘¨ç·šèšåˆ (é‚è¼¯ä¸è®Šï¼Œä½†è³‡æ–™é‡è®Šå¤§)
        resampleToBiWeekly: (dailyData) => {
            const grouped = {};
            dailyData.forEach(tick => {
                const d = dayjs(tick.date);
                // ä½¿ç”¨ å¹´ä»½-é›™å‘¨ ä½œç‚º Keyï¼Œç¢ºä¿ 2005-2025 ä¸æœƒé‡ç–Š
                const biWeekIndex = Math.floor(d.week() / 2);
                // PadStart ç¢ºä¿æ’åºæ­£ç¢º: 2005-BW01, 2005-BW02
                const key = `${d.year()}-BW${String(biWeekIndex).padStart(2, '0')}`;

                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(tick);
            });

            return Object.keys(grouped).sort().map(key => {
                const ticks = grouped[key];
                return {
                    date: key,
                    open: ticks[0].open,
                    close: ticks[ticks.length - 1].close,
                    high: Math.max(...ticks.map(t => t.high)),
                    low: Math.min(...ticks.map(t => t.low)),
                    values: [ // Open, Close, Low, High
                        ticks[0].open,
                        ticks[ticks.length - 1].close,
                        Math.min(...ticks.map(t => t.low)),
                        Math.max(...ticks.map(t => t.high))
                    ]
                };
            });
        }
    };

    // --- 3. [View] æ¸²æŸ“å±¤ ---
    function initApp() {
        const statusEl = document.getElementById('status');

        // 1. ç”Ÿæˆè³‡æ–™
        console.time("GenerateData");
        const dailyData = DataService.generateLongTermData();
        console.timeEnd("GenerateData");

        // 2. è½‰æ›é›™å‘¨ç·š
        console.time("Resample");
        const biWeeklyData = DataService.resampleToBiWeekly(dailyData);
        console.timeEnd("Resample");

        // 3. è¨ˆç®— MACD
        const closePrices = biWeeklyData.map(item => item.close);
        const macdResult = TechUtils.calculateMACD(closePrices);

        statusEl.innerHTML = `
            çµ±è¨ˆç¯„åœï¼š<b>${dailyData[0].date}</b> è‡³ <b>${dailyData[dailyData.length-1].date}</b><br>
            åŸå§‹æ—¥Kï¼š${dailyData.length.toLocaleString()} ç­† |
            èšåˆé›™å‘¨Kï¼š${biWeeklyData.length.toLocaleString()} ç­†
        `;

        // 4. ECharts è¨­å®š
        const chartDom = document.getElementById('chart');
        const myChart = echarts.init(chartDom);

        const option = {
            title: { text: 'æ¨¡æ“¬è‚¡åƒ¹èµ°å‹¢åœ– (2005-2025)', left: 'center' },
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'cross' },
                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                borderWidth: 1,
                borderColor: '#ccc',
                padding: 10,
                textStyle: { color: '#000' }
            },
            axisPointer: { link: { xAxisIndex: 'all' } },
            legend: { top: 30, data: ['é›™å‘¨K', 'MACD'] },
            grid: [
                { left: '5%', right: '5%', top: '10%', height: '55%' },
                { left: '5%', right: '5%', top: '72%', height: '20%' } // MACD å€å¡Š
            ],
            xAxis: [
                {
                    type: 'category',
                    data: biWeeklyData.map(d => d.date),
                    axisLine: { lineStyle: { color: '#8392A5' } }
                },
                {
                    type: 'category',
                    gridIndex: 1,
                    data: biWeeklyData.map(d => d.date),
                    axisLabel: { show: false }
                }
            ],
            yAxis: [
                { scale: true, splitLine: { show: true, lineStyle: { color: '#eee' } } },
                { scale: true, gridIndex: 1, splitLine: { show: false } }
            ],
            // é—œéµè¨­å®šï¼šDataZoom è®“ä½ å¯ä»¥æ»‘å‹•æŸ¥çœ‹ 20 å¹´è³‡æ–™
            dataZoom: [
                {
                    type: 'inside',
                    xAxisIndex: [0, 1],
                    start: 95, // é è¨­åªçœ‹æœ€å¾Œ 5% (2024-2025)
                    end: 100
                },
                {
                    type: 'slider',
                    xAxisIndex: [0, 1],
                    top: '94%',
                    start: 95,
                    end: 100
                }
            ],
            series: [
                {
                    name: 'é›™å‘¨K',
                    type: 'candlestick',
                    data: biWeeklyData.map(d => d.values),
                    itemStyle: {
                        color: '#eb5454',
                        color0: '#47b262',
                        borderColor: '#eb5454',
                        borderColor0: '#47b262'
                    },
                    large: true // é–‹å•Ÿå¤§æ•¸æ“šé‡å„ªåŒ–
                },
                {
                    name: 'DIF', type: 'line', xAxisIndex: 1, yAxisIndex: 1,
                    data: macdResult.dif,
                    lineStyle: { color: '#DA6EE8', width: 1.5 }, symbol: 'none'
                },
                {
                    name: 'DEA', type: 'line', xAxisIndex: 1, yAxisIndex: 1,
                    data: macdResult.dea,
                    lineStyle: { color: '#00D5FA', width: 1.5 }, symbol: 'none'
                },
                {
                    name: 'MACD', type: 'bar', xAxisIndex: 1, yAxisIndex: 1,
                    data: macdResult.macdBar,
                    itemStyle: { color: (p) => p.value > 0 ? '#eb5454' : '#47b262' }
                }
            ]
        };

        myChart.setOption(option);
        window.addEventListener('resize', myChart.resize);
    }

    initApp();
</script>

</body>
</html>