<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡çœŸå¯¦æ­·å²å›æ¸¬ - å¯åˆ‡æ›é€±æœŸ MACD</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/weekOfYear.js"></script>

    <style>
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; margin: 20px; background: #f4f6f8; }
        .card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { margin-top: 0; color: #2c3e50; border-left: 5px solid #3498db; padding-left: 10px; }
        #chart { width: 100%; height: 700px; }
        .status { margin-bottom: 15px; color: #7f8c8d; font-size: 0.95em; font-family: monospace; }
        .badge { background: #28a745; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;}
        .controls { margin-bottom: 20px; }
        .btn {
            background: #e9ecef;
            border: 1px solid #ced4da;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            margin-right: 8px;
            transition: background 0.2s, color 0.2s;
        }
        .btn:hover { background: #d3d9df; }
        .btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
    </style>
</head>
<body>

<div class="card">
    <h2 id="chart-title">ğŸ“ˆ å°ç£åŠ æ¬ŠæŒ‡æ•¸æ­·å²å›æ¸¬ <span class="badge">Real Data</span></h2>
    <div class="controls">
        <button class="btn active" data-period="daily">æ—¥ç·š</button>
        <button class="btn" data-period="weekly">å‘¨ç·š</button>
        <button class="btn" data-period="bi-weekly">é›™å‘¨ç·š</button>
        <button class="btn" data-period="tri-weekly">ä¸‰å‘¨ç·š</button>
        <button class="btn" data-period="monthly">æœˆç·š</button>
    </div>
    <div class="status" id="status">ç³»çµ±ç‹€æ…‹ï¼šåˆå§‹åŒ–...</div>
    <div id="chart"></div>
</div>

<script>
    // --- 0. è¨­å®š Day.js ---
    dayjs.extend(window.dayjs_plugin_weekOfYear);

    // --- 1. [Utils] æ•¸å­¸è¨ˆç®—å·¥å…· (æ¡ç”¨SMAé ç†±ï¼Œå‘½åèˆ‡æ¨¹ç²¾éˆåŒæ­¥) ---
    const TechUtils = {
        calculateSMA: (data, period) => {
            if (!data || data.length < period) {
                return new Array(data.length).fill(null);
            }
            const smaArray = new Array(data.length).fill(null);
            let sum = 0;
            for (let i = 0; i < data.length; i++) {
                sum += data[i];
                if (i >= period) {
                    sum -= data[i - period];
                    smaArray[i] = sum / period;
                } else if (i === period - 1) {
                    smaArray[i] = sum / period;
                }
            }
            return smaArray;
        },

        calculateEMA: (data, period) => {
            if (!data || data.length < period) {
                return new Array(data.length).fill(null);
            }

            const k = 2 / (period + 1);
            const emaArray = new Array(data.length).fill(null);

            let sma = 0;
            for (let i = 0; i < period; i++) {
                sma += data[i];
            }
            emaArray[period - 1] = sma / period;

            for (let i = period; i < data.length; i++) {
                emaArray[i] = (data[i] * k) + (emaArray[i - 1] * (1 - k));
            }

            return emaArray;
        },

        calculateMACD: (closePrices, shortPeriod = 12, longPeriod = 26, midPeriod = 9) => {
            const totalLength = closePrices.length;
            if (totalLength < longPeriod + midPeriod -1) {
                return { dif: [], macd: [], dm: [] };
            }

            const shortEMA = TechUtils.calculateEMA(closePrices, shortPeriod);
            const longEMA = TechUtils.calculateEMA(closePrices, longPeriod);

            const dif = new Array(totalLength).fill(null);
            for (let i = longPeriod - 1; i < totalLength; i++) {
                if (longEMA[i] !== null && shortEMA[i] !== null) {
                     dif[i] = shortEMA[i] - longEMA[i];
                }
            }

            const difValues = dif.slice(longPeriod - 1);
            const macdValues = TechUtils.calculateEMA(difValues, midPeriod);

            const macd = new Array(totalLength).fill(null);
            for (let i = 0; i < macdValues.length; i++) {
                if (macdValues[i] !== null) {
                    macd[i + longPeriod - 1] = macdValues[i];
                }
            }
            
            const dm = new Array(totalLength).fill(null);
            const startIndex = longPeriod - 1 + midPeriod - 1;
            for (let i = startIndex; i < totalLength; i++) {
                 if (dif[i] !== null && macd[i] !== null) {
                    dm[i] = dif[i] - macd[i];
                 }
            }

            return { dif, macd, dm };
        }
    };

    // --- 2. [Service] è³‡æ–™è™•ç†å±¤ (æ”¹ç‚ºä¸²æ¥çœŸå¯¦ API) ---
    const DataService = {
        fetchRealData: async () => {
            const API_URL = 'https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=TAIEX&start_date=1997-01-01';
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                const result = await response.json();
                if (result.data && result.data.length > 0) {
                    return result.data.map(item => ({
                        date: item.date,
                        open: item.open,
                        high: item.max,
                        low: item.min,
                        close: item.close,
                        values: [item.open, item.close, item.min, item.max]
                    }));
                } else {
                    throw new Error('No data received from API');
                }
            } catch (error) {
                console.error("Failed to fetch real data:", error);
                return [];
            }
        },

        resampleToPeriod: (dailyData, periodType) => {
            if (periodType === 'daily') {
                return dailyData.map(d => ({ ...d, date: d.date }));
            }

            const grouped = {};
            dailyData.forEach(tick => {
                const d = dayjs(tick.date);
                let key;
                switch (periodType) {
                    case 'weekly':
                        key = `${d.year()}-W${String(d.week()).padStart(2, '0')}`;
                        break;
                    case 'bi-weekly':
                        const biWeekIndex = Math.floor(d.week() / 2);
                        key = `${d.year()}-BW${String(biWeekIndex).padStart(2, '0')}`;
                        break;
                    case 'tri-weekly':
                        const triWeekIndex = Math.floor(d.week() / 3);
                        key = `${d.year()}-TW${String(triWeekIndex).padStart(2, '0')}`;
                        break;
                    case 'monthly':
                        key = d.format('YYYY-MM');
                        break;
                }

                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(tick);
            });

            return Object.keys(grouped).sort().map(key => {
                const ticks = grouped[key];
                const firstTick = ticks[0];
                const lastTick = ticks[ticks.length - 1];

                const open = firstTick.open;
                const close = lastTick.close;
                const high = Math.max(...ticks.map(t => t.high));
                const low = Math.min(...ticks.map(t => t.low));
                
                const displayDate = `${firstTick.date} ~ ${lastTick.date}`;

                return { 
                    date: displayDate,
                    open, 
                    close, 
                    high, 
                    low, 
                    values: [open, close, low, high] 
                };
            });
        }
    };

    // --- 3. [View] æ¸²æŸ“å±¤ (æ”¹ç‚ºéåŒæ­¥ async function) ---
    async function initApp() {
        const statusEl = document.getElementById('status');
        const chartTitleEl = document.getElementById('chart-title');
        const chartDom = document.getElementById('chart');
        const myChart = echarts.init(chartDom);
        const controlButtons = document.querySelectorAll('.btn');

        statusEl.innerHTML = `ç³»çµ±ç‹€æ…‹ï¼š<span style="color: #3498db;">æ­£åœ¨å¾ FinMind API ç²å–çœŸå¯¦å°è‚¡åŠ æ¬ŠæŒ‡æ•¸æ­·å²è³‡æ–™...</span>`;

        console.time("FetchRealData");
        const dailyData = await DataService.fetchRealData();
        console.timeEnd("FetchRealData");
        
        if (dailyData.length === 0) {
             statusEl.innerHTML = `ç³»çµ±ç‹€æ…‹ï¼š<span style="color: red;">ç²å–çœŸå¯¦è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚åœ–è¡¨ç„¡æ³•è¼‰å…¥ã€‚</span>`;
             return;
        }

        statusEl.innerHTML = `ç³»çµ±ç‹€æ…‹ï¼šçœŸå¯¦è³‡æ–™è¼‰å…¥æˆåŠŸï¼Œè«‹é¸æ“‡æ™‚é–“é€±æœŸã€‚`;

        let currentPeriod = 'daily';

        function updateChart(periodType) {
            console.time(`UpdateChart-${periodType}`);
            currentPeriod = periodType;

            controlButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === periodType);
            });

            statusEl.innerHTML = `ç³»çµ±ç‹€æ…‹ï¼šæ­£åœ¨å°‡ ${dailyData.length.toLocaleString()} ç­†æ—¥Kè½‰æ›ç‚º ${periodType} è³‡æ–™...`;
            console.time(`Resample-${periodType}`);
            const resampledData = DataService.resampleToPeriod(dailyData, periodType);
            console.timeEnd(`Resample-${periodType}`);

            const closePrices = resampledData.map(item => item.close);
            const macdResult = TechUtils.calculateMACD(closePrices);
            const ma5 = TechUtils.calculateSMA(closePrices, 5);
            const ma10 = TechUtils.calculateSMA(closePrices, 10);
            const ma20 = TechUtils.calculateSMA(closePrices, 20);

            const periodMap = { 'daily': 'æ—¥ç·š', 'weekly': 'å‘¨ç·š', 'bi-weekly': 'é›™å‘¨ç·š', 'tri-weekly': 'ä¸‰å‘¨ç·š', 'monthly': 'æœˆç·š' };
            const periodName = periodMap[periodType];
            chartTitleEl.innerHTML = `ğŸ“ˆ å°ç£åŠ æ¬ŠæŒ‡æ•¸ ${periodName} MACD <span class="badge">Real Data</span>`;

            statusEl.innerHTML = `
                çµ±è¨ˆç¯„åœï¼š<b>${dailyData[0].date}</b> è‡³ <b>${dailyData[dailyData.length-1].date}</b><br>
                åŸå§‹æ—¥Kï¼š${dailyData.length.toLocaleString()} ç­† |
                èšåˆ${periodName}ï¼š${resampledData.length.toLocaleString()} ç­†
            `;

            const option = {
                title: { text: `å°ç£åŠ æ¬ŠæŒ‡æ•¸ (${periodName})`, left: 'center' },
                tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
                axisPointer: { link: { xAxisIndex: 'all' } },
                legend: { top: 30, data: [periodName, 'MA5', 'MA10', 'MA20', 'DIF', 'MACD', 'D-M'] },
                grid: [
                    { left: '5%', right: '5%', top: '10%', height: '55%' },
                    { left: '5%', right: '5%', top: '72%', height: '20%' }
                ],
                xAxis: [
                    { type: 'category', data: resampledData.map(d => d.date) },
                    { type: 'category', gridIndex: 1, data: resampledData.map(d => d.date), axisLabel: { show: false } }
                ],
                yAxis: [
                    { scale: true, splitLine: { show: true, lineStyle: { color: '#eee' } } },
                    { scale: true, gridIndex: 1, splitLine: { show: false } }
                ],
                dataZoom: [
                    { type: 'inside', xAxisIndex: [0, 1], start: 95, end: 100 },
                    { type: 'slider', xAxisIndex: [0, 1], top: '94%', start: 95, end: 100 }
                ],
                series: [
                    {
                        name: periodName, type: 'candlestick', data: resampledData.map(d => d.values),
                        itemStyle: { color: '#eb5454', color0: '#47b262', borderColor: '#eb5454', borderColor0: '#47b262' },
                        large: true
                    },
                    { name: 'MA5', type: 'line', data: ma5, smooth: true, lineStyle: { width: 1.5, color: '#FFBF00' }, symbol: 'none' },
                    { name: 'MA10', type: 'line', data: ma10, smooth: true, lineStyle: { width: 1.5, color: '#8A2BE2' }, symbol: 'none' },
                    { name: 'MA20', type: 'line', data: ma20, smooth: true, lineStyle: { width: 1.5, color: '#32CD32' }, symbol: 'none' },
                    { name: 'DIF', type: 'line', xAxisIndex: 1, yAxisIndex: 1, data: macdResult.dif, lineStyle: { color: '#DA6EE8', width: 1.5 }, symbol: 'none' },
                    { name: 'MACD', type: 'line', xAxisIndex: 1, yAxisIndex: 1, data: macdResult.macd, lineStyle: { color: '#00D5FA', width: 1.5 }, symbol: 'none' },
                    { name: 'D-M', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: macdResult.dm, itemStyle: { color: (p) => p.value > 0 ? '#eb5454' : '#47b262' } }
                ]
            };

            myChart.setOption(option, true);
            console.timeEnd(`UpdateChart-${periodType}`);
        }

        controlButtons.forEach(button => {
            button.addEventListener('click', () => {
                const period = button.dataset.period;
                if (period !== currentPeriod) {
                    updateChart(period);
                }
            });
        });

        updateChart(currentPeriod);
        window.addEventListener('resize', myChart.resize);
    }

    initApp();
</script>

</body>
</html>